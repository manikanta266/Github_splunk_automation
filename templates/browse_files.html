<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>File Browser & Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 CSS -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      background: #f8f9fa;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .editor-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 280px;
      background: #fff;
      border-right: 1px solid #dee2e6;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .sidebar h5 {
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .file-link {
      display: block;
      padding: 6px 0;
      color: #0d6efd;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s ease-in-out;
      font-weight: 500;
    }
    .file-link:hover {
      text-decoration: underline;
      color: #0a58ca;
    }
    .main-panel {
      display: flex;
      flex-grow: 1;
      height: 100vh;
      overflow: hidden;
    }
    .file-viewer, .file-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      border-left: 1px solid #dee2e6;
      overflow: hidden;
    }
    .file-viewer h5,
    .file-editor h5 {
      margin-bottom: 0.8rem;
      font-weight: 600;
      color: #343a40;
    }
    .monaco-container {
      flex-grow: 1;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      min-height: 400px;
      background: #1e1e1e;
      overflow: hidden;
    }
    .btn-bar {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
    }
    .btn-bar button,
    .btn-bar a.btn {
      flex: 1;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
    }
    .alert {
      margin-bottom: 1rem;
      font-size: 0.95rem;
      border-radius: 0.375rem;
    }
    .sidebar::-webkit-scrollbar {
      width: 8px;
    }
    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }
    .sidebar::-webkit-scrollbar-thumb {
      background-color: #ced4da;
      border-radius: 4px;
    }
    /* Responsive */
    @media (max-width: 767.98px) {
      body {
        overflow: auto;
      }
      .editor-container {
        flex-direction: column;
        height: auto;
      }
      .sidebar {
        width: 100%;
        height: 150px;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
      }
      .main-panel {
        flex-direction: column;
        height: calc(100vh - 150px);
      }
      .file-viewer, .file-editor {
        flex: none;
        height: 50%;
        border-left: none;
        border-top: 1px solid #dee2e6;
      }
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <nav class="sidebar">
      <!-- Upload Progress Modal -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" aria-labelledby="uploadProgressLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadProgressLabel">Uploading to Splunk...</h5>
      </div>
      <div class="modal-body" style="max-height: 300px; overflow-y: auto;">
        <div id="uploadMessages" style="font-family: monospace; white-space: pre-wrap;"></div>
        <div id="uploadSpinner" class="text-center my-3">
          <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
          <div>Processing...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="closeUploadModalBtn" class="btn btn-primary" data-bs-dismiss="modal" disabled>Close</button>
      </div>
    </div>
  </div>
</div>
 
      <h5>File Browser</h5>
 
      {% if get_flashed_messages(with_categories=true) %}
        {% for category, message in get_flashed_messages(with_categories=true) %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} d-flex align-items-center" role="alert">
            <i class="bi {{ 'bi-check-circle' if category=='success' else 'bi-exclamation-circle' }} me-2"></i>
            <div>{{ message }}</div>
          </div>
        {% endfor %}
      {% endif %}
 
      {% for folder in folders %}
        <div>üìÅ <a class="file-link" href="{{ url_for('browse_files', app_id=app_id, folder_path=folder.full_path) }}">{{ folder.name }}</a></div>
      {% endfor %}
      {% for file in files %}
        <div>üìÑ <a class="file-link" href="{{ url_for('browse_files', app_id=app_id, folder_path=file.full_path) }}">{{ file.name }}</a></div>
      {% endfor %}
 
      <hr />
 
      <a href="{{ url_for('download_app', app_id=app_id) }}" class="btn btn-outline-primary btn-sm w-100 mb-2">
        <i class="bi bi-download me-1"></i> Download ZIP
      </a>
 
      <!-- Upload to Splunk Button inside sidebar -->
      <form id="uploadSplunkForm" method="POST" style="margin-bottom: 1rem;">
        <button id="uploadSplunkBtn" type="button" class="btn btn-primary w-100">
          <i class="bi bi-cloud-upload-fill me-1"></i> Upload to Splunk
        </button>
        <!-- <div id="uploadStatus" class="mt-2"></div> -->
      </form>
 
      {% if parent_path %}
      <a href="{{ url_for('browse_files', app_id=app_id, folder_path=parent_path) }}" class="btn btn-outline-secondary btn-sm w-100 mb-2">
        <i class="bi bi-arrow-left me-1"></i> Back
      </a>
      {% endif %}
 
      <a href="{{ url_for('home') }}" class="btn btn-outline-primary btn-sm w-100">
        <i class="bi bi-house-door me-1"></i> Home
      </a>
    </nav>
 
    <section class="main-panel">
      {% if selected_file %}
        <section class="file-viewer">
          <h5>Viewing: {{ selected_file }}</h5>
          <div id="viewer" class="monaco-container" aria-label="Read-only file viewer"></div>
        </section>
        <section class="file-editor">
          <h5>Editing: {{ selected_file }}</h5>
          <form method="POST" onsubmit="beforeSubmit()" action="{{ url_for('validate_and_save', app_id=app_id) }}?file={{ current_path }}/{{ selected_file }}" style="flex-grow:1; display:flex; flex-direction:column;">
            <textarea id="code" name="content" hidden>{{ content | trim }}</textarea>
            <div id="editor" class="monaco-container" aria-label="Editable file editor"></div>
            <div class="btn-bar">
              {% if readonly %}
                <button type="submit" class="btn btn-success" disabled title="Read-only mode: editing disabled">üíæ Save</button>
              {% else %}
                <button type="submit" class="btn btn-success">üíæ Save</button>
              {% endif %}
              <a href="{{ url_for('browse_files', app_id=app_id, folder_path=current_path) }}" class="btn btn-secondary">Cancel</a>
            </div>
          </form>
        </section>
      {% else %}
        <div class="d-flex align-items-center justify-content-center flex-grow-1 text-muted" style="font-size:1.2rem;">
          Select a file to view and edit.
        </div>
      {% endif %}
    </section>
  </div>
 
  <!-- Monaco Editor loader -->
  <script src="https://unpkg.com/monaco-editor@0.34.1/min/vs/loader.js"></script>
  <script>
    require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.34.1/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      const iniContent = {{ content | tojson }};
 
      // Read-only viewer
      monaco.editor.create(document.getElementById('viewer'), {
        value: iniContent,
        language: 'ini',
        theme: 'vs-dark',
        readOnly: true,
        lineNumbers: 'on',
        automaticLayout: true,
        minimap: { enabled: false }
      });
 
      // Editable editor
      window.monacoEditor = monaco.editor.create(document.getElementById('editor'), {
        value: iniContent,
        language: 'ini',
        theme: 'vs-dark',
        fontSize: 14,
        lineNumbers: 'on',
        automaticLayout: true,
        minimap: { enabled: false },
        tabSize: 2,
        insertSpaces: false,
        detectIndentation: false
      });
 
      window.beforeSubmit = function () {
        let value = window.monacoEditor.getValue();
 
        // Remove trailing spaces and tabs on each line before submitting
        const cleaned = value
          .split('\n')
          .map(line => line.replace(/[ \t]+$/g, ''))
          .join('\n');
 
        document.getElementById('code').value = cleaned;
      };
    });
 
    // Upload to Splunk button logic, run after DOM ready
   document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('uploadSplunkBtn');
  const statusDiv = document.getElementById('uploadStatus');
 
  btn.addEventListener('click', () => {
    // Clear previous status
    statusDiv.innerHTML = '';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
 
    const content = window.monacoEditor ? window.monacoEditor.getValue() : '';
 
    fetch('{{ url_for("upload_to_splunk", app_id=app_id) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      // Join all messages with line breaks for better readability
      const messageHTML = (data.messages && data.messages.length)
        ? data.messages.map(msg => `<div>${msg}</div>`).join('')
        : (data.message || 'Upload failed');
 
      if (data.status === 'success') {
        statusDiv.innerHTML = `<div class="alert alert-success">${messageHTML}</div>`;
      } else {
        statusDiv.innerHTML = `<div class="alert alert-danger">${messageHTML}</div>`;
      }
    })
    .catch(() => {
      statusDiv.innerHTML = `<div class="alert alert-danger">Network error during upload</div>`;
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-cloud-upload-fill me-1"></i> Upload to Splunk';
    });
  });
});
 
 
 
 
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('uploadSplunkBtn');
  const modalEl = document.getElementById('uploadProgressModal');
  const uploadMessagesDiv = document.getElementById('uploadMessages');
  const uploadSpinner = document.getElementById('uploadSpinner');
  const closeBtn = document.getElementById('closeUploadModalBtn');
 
  // Initialize Bootstrap modal instance
  const uploadModal = new bootstrap.Modal(modalEl, { keyboard: false, backdrop: 'static' });
 
  btn.addEventListener('click', () => {
    // Clear previous messages & reset modal UI
    uploadMessagesDiv.innerHTML = '';
    uploadSpinner.style.display = 'block';
    closeBtn.disabled = true;
    closeBtn.style.display = 'none';  // hide close button initially
 
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
 
    // Show modal
    uploadModal.show();
 
    const content = window.monacoEditor ? window.monacoEditor.getValue() : '';
 
    fetch('{{ url_for("upload_to_splunk", app_id=app_id) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      // Show each message line by line with a small delay for effect
      const messages = (data.messages && data.messages.length) ? data.messages : [data.message || 'Upload failed'];
      uploadMessagesDiv.innerHTML = '';
 
      let i = 0;
 
      function showNextMessage() {
        if (i < messages.length) {
          uploadMessagesDiv.innerHTML += messages[i] + '\n';
          uploadMessagesDiv.scrollTop = uploadMessagesDiv.scrollHeight; // auto scroll
          i++;
          setTimeout(showNextMessage, 300); // 300ms delay between lines
        } else {
          // After all messages, update modal UI
          uploadSpinner.style.display = 'none';
          closeBtn.disabled = false;
          closeBtn.style.display = 'inline-block';
        }
      }
 
      showNextMessage();
 
      if (data.status === 'success') {
        modalEl.querySelector('.modal-title').textContent = 'Upload Completed Successfully!';
      } else {
        modalEl.querySelector('.modal-title').textContent = 'Upload Failed!';
      }
    })
    .catch(() => {
      uploadMessagesDiv.innerHTML = 'Network error during upload';
      uploadSpinner.style.display = 'none';
      closeBtn.disabled = false;
      closeBtn.style.display = 'inline-block';
      modalEl.querySelector('.modal-title').textContent = 'Upload Failed!';
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-cloud-upload-fill me-1"></i> Upload to Splunk';
    });
  });
});
 
 
</script>
</body>
</html>
 
 